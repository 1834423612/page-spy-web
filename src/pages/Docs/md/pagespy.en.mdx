import mpPanelImg from '@/assets/image/screenshot/mp-panel.png';
import mpDataHarborImg from '@/assets/image/screenshot/mp-data-harbor.png';
import { LinkOutlined } from '@ant-design/icons';
import PlatformTag from '../components/PlatformTag'

## PageSpy API#api

> - The tag on the right of each API title indicate the exclusive env for this API, for example:
>
>   <LinkOutlined/> **config.clientOrigin  <PlatformTag type="browser" />**
>
>   This tag indicates the API can only be used in the browser environment。
> - The tags in the details below the API title indicate the platform differences of the API.



#### constructor()#constructor

Create a PageSpy instance.

- Type:

  ```ts
  declare class PageSpy {
    constructor(config: InitConfig)
  }
  ```

- Details: 

  The constructor accepts an `config` object as the initialization parameter.

  Before the initialization, the SDK will not hack any native API. 

#### config.api

The address of PageSpy service.

- Type: `string`

- **<PlatformTag type="browser" />**

  SDK will automatically determine server address (api) and client origin (clientOrigin) from the imported path. For example, if you import SDK `<script src="https://example.com/page-spy/index.min.js">`, SDK will internally set:
  - api: `"example.com"`
  - clientOrigin: `"https://example.com"`

  If your service is deployed elsewhere, you need to manually specify to override.

- **<PlatformTag type="mp" /> <PlatformTag type="rn" /> <PlatformTag type="harmony" />**

  This option is mandatory.

#### config.clientOrigin <PlatformTag type="browser" />

The origin of the debug panel.

- Type: `string`

- Details:

  The value will be used when copy the debug url on the 

  There could be a "Copy the debug url" button on the PageSpy popup, by default, the url uses the same origin as `api` option. By setting this option, you can specify the origin of the debug panel.

  Only applicable for browser environment.
  

#### config.project

Project serves as an aggregation of information, searchable in the room list.
  
- Type: `string`
- Default: `default`

    
    
#### config.title

Title allows users to provide custom parameters for distinguishing the current client. It will appears below the "device id" in each connection panel.

- Type: `string`
- Default: `--`

    
#### config.enableSSL

Manually specify PageSpy service scheme.

- Type: `boolean`  

- Details: 

  Pass boolean value:
    - true: SDK will access PageSpy service via ["https://", "wss://"]
    - false: SDK will access PageSpy service via ["http://", "ws://"]

- **<PlatformTag type="browser" />**

  If not set, SDK will analyze automatically according to the page's protocol.

  This can be used if SDK cannot correctly analyze the scheme, such as PageSpy's browser plugin is imported via chrome-extension://xxx/sdk/index.min.js, which SDK interprets as invalid "chrome-extension://" and falls back

- **<PlatformTag type="mp" /> <PlatformTag type="rn" /> <PlatformTag type="harmony" />**

  These platform normally require https mandatorily, so the default value is `true`. You may need to manually set to `false` in dev env.


  
#### config.disabledPlugins

All internal plugins are carried with PageSpy by default out of the box. You can disable some plugins as needed.

- Type: `string[]`


#### config.serializeData

Specify whether the SDK is allowed to serialize non-primitive data types when collecting offline data.

- Type: `boolean`
- Default: `false`


#### config.useSecret

Indicate whether authorization is required. 

- Type: `boolean`
- Default: `false`
- Details: 

  If enabled, PageSpy generates a 6-digit random number (below "secret") as a password for the debug room, which is required for developers to access the debug room.
  
#### config.messageCapacity

Specify how many messages to cache.

- Type: `number`
- Default: `1000`
- Details: 

  The data is primarily used to configure the maximum number of historical data the SDK can send after the debugging terminal goes online.


#### config.dataProcessor

User can process the data to be collected.

- Type: 
  ```ts
  declare interface DataProcessor {
    console?: (data: ConsoleData) => boolean;
    network?: (data: RequestItem) => boolean;
    storage?: (data: StorageData) => boolean;
    database?: (data: DatabaseData) => boolean;
    page?: (data: PageData) => boolean;
    system?: (data: SystemData) => boolean;
  }
  ```

- Details: 

  Each processing method corresponds to an internal plugin, each log will be passed to the process method defined by user, and user can customize, modify, or ignore it. If the function returns false, PageSpy will ignore the log, then the log will not in neither the online debug panel nor offline data replay.

  View details: https://www.pagespy.org/#/docs/changelog#v1_9_2


#### config.disabledOnProd <PlatformTag type="mp" />

Disable the PageSpy in production env of miniprogram。

- Type: `boolean`
- Default: `true`
- Details: 

  As a debug tool, PageSpy is mainly for dev and debug phase, and is not recommended in production. Moreover, miniprogram platforms usually have strict audit rules.


#### config.offline <PlatformTag type="browser" />

- Type: `boolean`

- Default: `false`

- Details: 

  After PageSpy@1.7.4 supports offline playback function, SDK integrated into the client can collect data, export offline logs, and become a new usage mode.
  Default value is false. When set to other values, it enters "offline mode", where PageSpy does not create rooms or establish WebSocket connections.

  Currently only support browser SDK。


#### config.autoRender <PlatformTag type="browser" />

Indicates whether SDK initializes and automatically renders "circular white logo on a white background" control in the lower left corner of the client.

- Type: `boolean`

- Default: `true`

- Details: 

  If set to false, you can call window.$pageSpy.render() to render manually.


#### config.logo <PlatformTag type="browser" />

Custom control rendering logo.

- Type: `string`

#### config.primaryColor <PlatformTag type="browser" />

Set the theme color, which is used in modals and toasts.

- Type: `string`

#### config.modal <PlatformTag type="browser" />

Set the logo and title in the modal.

- Type: 

  ```ts
  declare interface ModalConfig {
    logo?: string;
    title?: string;
  }
  ```
- Default: 
```ts
{
  logo: "",
  title: "PageSpy"
}
```

#### registerPlugin()#registerPlugin

Static method, register a plugin.

- Type

  ```ts
  declare class PageSpy {
    static registerPlugin(plugin: PageSpyPlugin): void;
  }
  ```

- Details

  Call before `new PageSpy`, the parameter is an instance of a plugin that implements `PageSpyPlugin`. Each plugin instance should have a `name` attribute. If a plugin with the same name is registered multiple times, the plugin instance will only be registered once, and a warning message will be printed in the console.

- Example

  ```ts
  class DataHarbrPlugin implements PageSpyPlugin {
    name = 'DataHarborPlugin'

    ... // some code
  }

  PageSpy.registerPlugin(new DataHarborPlugin());

  // Repeated calls, the plugin will only be registered once
  PageSpy.registerPlugin(new DataHarborPlugin());
  ```

#### pluginsWithOrder

List of registered plugins sorted by the `enforce` property of the plugin.

- Type

  ```ts
  declare class PageSpy {
    static plugins: Record<PluginOrder | 'normal', PageSpyPlugin[]>;
    static get pluginsWithOrder(): PageSpyPlugin[];
  }
  ```

- Details

  Each plugin should provide the `enforce: PluginOrder` attribute; if not provided, it defaults to `enforce: "normal"`. PageSpy will then maintain the plugin list in the order of `pre - normal - post`.

#### updateRoomInfo()#updateRoomInfo

Update connection info after instantiation PageSpy.

- Type

  ```ts
  type UpdateConfig = {
    title?: string;
    project?: string;
  };

  declare class PageSpy {
    updateRoomInfo(obj: UpdateConfig): void;
  }
  ```

- Details

  The client identification information can be updated later through this method if it is not known when PageSpy is initialized.

- Example

  ```ts
  window.$pageSpy = new PageSpy({
    title: '--',
    project: '--',
  });

  async function YourCode() {
    const { title, project } = await xxx();

    window.$pageSpy.updateRoomInfo({
      title,
      project,
    });
  }
  ```

#### abort()#abort

Abort the current PageSpy instance.

- Type

  ```ts
  declare class PageSpy {
    abort(): void;
  }
  ```

- Details

  PageSpy will disconnect, remove the relevant DOM from the document, clear the cached data, and call the `onReset()` method of all registered plugins.

  In the current context, APIs that are proxied or rewritten, such as `window.fetch` in the browser, will be restored to their state before PageSpy was instantiated.

- Example

  ```ts
  window.$pageSpy = new PageSpy(...);

  window.$pageSpy.abort();
  ```

#### version

Current used version of PageSpy.

- Type

  ```ts
  declare class PageSpy {
    version: string;
  }
  ```

- Example

  ```ts
  window.$pageSpy = new PageSpy(...);

  console.log(window.$pageSpy.version);
  ```

#### config

Configuration information. The configuration varies depending on the platform, such as `config.disableOnProd` which is specific to the mini-program end.

- Type

  ```ts
  declare class PageSpy {
    config: Config;
  }
  ```

#### socketStore

Encapsulates the WebSocket instance, provides message event listeners, triggers callbacks upon receiving specified messages, and broadcasts messages.

- Type

  ```ts
  interface SocketStoreType {
    addListener(type: InteractiveType, fn: InteractiveEventCallback): void;
    addListener(type: InternalType, fn: InternalEventCallback): void;

    removeListener(type: InteractiveType, fn: InteractiveEventCallback): void;
    removeListener(type: InternalType, fn: InternalEventCallback): void;

    dispatchEvent(
      type: InteractiveType | InternalType,
      data: InteractiveEvent,
    ): void;
    dispatchEvent(type: InternalType, data: any): void;

    broadcastMessage(message: MessageItem, noCache?: boolean): void;
  }
  ```

- Details

  The first parameter of `addListener() / removeListener() / dispatchEvent()` is the message type, which we categorize into **"interactive"** and **"internal"** types.

  - **"InteractiveType"** message types are used to interact with the debugging client, for example: when the debugging client goes online, sends code to the client for execution, or clicks to expand object details, these will be sent to the SDK as message events, and the SDK will respond accordingly;
  - **"InternalType"** message types are currently used for interaction between plugins. For example, after each plugin generates data, it will dispatch an event through `socketStore.dispatchEvent('public-data')`, and the `DataHarborPlugin`, also a plugin, can process the data upon listening to this event.

  The `broadcastMessage()` broadcasts a message. The first parameter is the data sent from different plugins to the debugging end, and the second parameter `noCache` is used by the plugin to inform `socketStore` whether the current message being sent should be cached. The purpose of caching the data is so that when the debugging end "comes online," it can see historical messages, but not all data needs to be cached. For instance, when a client send a network request, whether it succeeds or fails, only the final state needs to be cached.

- Example

  ```ts
  // Please check the repository for the specific implementation of ConsolePlugin
  class ConsolePlugin implements PageSpyPlugin {
    onInit({ socketStore }) {
      socketStore.addListener('debug', ({ source }, reply) => {
        ...
      })

      socketStore.broadcastMessage(...)
    }
  }
  ```


#### showPanel() <PlatformTag type="mp" />

Show the debugging panel in miniprogram.

- Type:
  ```ts
  declare class PageSpy {
    showPanel(): void;
  }
  ```
- Details:

  <img src={mpPanelImg} style={{width: 375}} />

  This panel supports plugin registration of custom buttons, for example, if the [DataHarborPlugin](./offline-log#mp) is registered, a button of「Upload Offline Log」will appear in the panel:

  <img src={mpDataHarborImg} style={{width: 375}} />


